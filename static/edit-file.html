<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/public/bootstrap.min.css">

    <title>Edit File - Recoit</title>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="/public/jquery-3.5.1.min.js"></script>
    <script src="/public/bootstrap.bundle.min.js"></script>
    <script src="/public/util.js"></script>

    <style>
#links-inputted .DeleteButton {
  visibility: hidden;
}
#links-inputted li:hover .DeleteButton {
  visibility: visible;
}
#links-inputted li:hover {
  background-color: lightgray;
}
#links-inputted .LinkAddress {
  color: black;
  text-decoration: none;
}
#links-inputted li:hover .LinkAddress {
  text-decoration: underline;
}
    </style>

  </head>

  <body>
    <div class="container" style="max-width: 680px; min-width: 400px;">
      <nav class="navbar navbar-light bg-light mt-1">
          <span class="navbar-brand mb-0 h1">Edit File</span>
          <div class="btn-toolbar" role="toolbar" aria-label="nav bar">
            <div class="btn-group mr-2" role="group">
              <a class="btn btn-outline-dark" href="/index" data-toggle="tooltip" title="Index">
                <img src="/public/icons/grid-3x3-gap.svg" alt="all" style="font-size:3rem;">
              </a>
              <a class="btn btn-outline-dark" href="/add-file" data-toggle="tooltip" title="add file">
                <img src="/public/icons/file-earmark-plus.svg" alt="add" style="font-size:3rem;">
              </a>
            </div>
          </div>
      </nav>

      <!--成功提示-->
      <template id="alert-success-tmpl">
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <span class="AlertMessage"></span>
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
        </div>
      </template>

      <!--错误提示-->
      <template id="alert-danger-tmpl">
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <span class="AlertMessage"></span>
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
        </div>
      </template>

      <div id="section-view" style="margin: 50px 0 50px 0;">
        <img id="thumbnail" class="img-thumbnail" alt="click to load the thumbnail" 
            style="width: 138px; height: 138px; display: none; cursor: pointer;">
        <img id="big-image" alt="click to hide" title="click to hide"
            class="img-fluid" style="display: none; cursor: pointer;">
        <div class="mb-3">
          <a id="download-btn"><img src="/public/icons/download.svg" alt="download icon"></a>
          <div id="file-size" style="display: inline;"></div>
          <div id="file-tags" style="display: inline;">
            <template id="tag-tmpl">
              <a href="#" class="badge badge-secondary"></a>
            </template>
          </div>
        </div>
        <p id="file-name" class="mb-0 text-break" style="font-weight: bold;"></p>
        <p id="description"></p>
        <ul id="links" class="list-group list-group-flush small">
          <template id="link-tmpl">
            <li class="list-group-item d-flex align-items-center pl-1 py-1">
              <img src="/public/icons/link.svg" alt="link icon">
              <a class="LinkAddress ml-1"></a>
            </li>
          </template>
        </ul>
      </div>

      <div id="section-toggle" class="custom-control custom-switch" style="display: none;">
        <input type="checkbox" id="toggle-edit" class="custom-control-input">
        <label class="custom-control-label" for="toggle-edit">Toggle Edit Mode</label>
        <span id="delete-file" style="display: none;"> | 
          <a id="delete-file-btn" href="#" style="color: red;">delete file</a>
        </span>
        <span id="delete-confirm" style="display: none;"> | 
          <span style="color: red;">move to recycle bin?</span>
          <button id="delete-yes-btn">Yes</button> <button id="delete-no-btn">No</button>
        </span>
      </div>

      <form id="file-form" autocomplete="off" style="margin: 50px 0 50px 0; display: none;">

        <div class="form-group row">
          <label for="file-input" class="col-sm-2 col-form-label">Replace File</label>
          <div class="col-sm-10">
            <input type="file" class="form-control-file" id="file-input">
          </div>
        </div>

        <div class="form-group row" id="new-thumb" style="display: none;">
          <div class="col-sm-2 col-form-label">Thumbnail</div>
          <div class="col-sm-10">
            <canvas class="img-thumbnail"></canvas>
          </div>
        </div>

        <div class="form-group row">
          <label for="file-size-input" class="col-sm-2 col-form-label">File Size</label>
          <div class="col-sm-10">
            <input type="text" readonly class="form-control-plaintext" id="file-size-input">
          </div>
        </div>

        <div class="form-group row">
          <label for="file-name-input" class="col-sm-2 col-form-label">File Name</label>
          <div class="col-sm-10">
            <input type="text" class="form-control" id="file-name-input">
          </div>
        </div>

        <div class="form-group row">
          <label for="tags-input" class="col-sm-2 col-form-label">Tags</label>
          <div class="col-sm-10">
            <input type="text" class="form-control" id="tags-input">
          </div>
        </div>

        <div class="form-group row">
          <label for="description-input" class="col-sm-2 col-form-label">Description</label>
          <div class="col-sm-10">
            <textarea class="form-control" id="description-input" rows="3"></textarea>
          </div>
        </div>

        <div class="form-group row">
          <label for="link-input" class="col-sm-2 col-form-label">Links</label>
          <div id="link-input-group" class="input-group col-sm-10">
            <input type="text" id="link-input" class="form-control" placeholder="https://">
            <div class="input-group-append">
              <button id="link-input-btn" class="btn btn-outline-primary">add</button>
            </div>
          </div>
        </div>

        <div class="form-group row">
          <label for="links-inputted" class="col-sm-2 col-form-label"></label>
          <ul id="links-inputted" style="padding-left: 1em;"
              class="input-group col-sm-10 list-group list-group-flush small">
            <template id="link-input-tmpl">
              <li class="list-group-item d-flex align-items-center pl-1 py-1">
                <a class="LinkAddress ml-1" target="_blank"></a>
                <img src="/public/icons/x-circle-fill.svg" class="ml-auto DeleteButton" alt="del">
              </li>
            </template>
          </ul>      
        </div>

        <!--更新时的错误提示-->
        <template id="alert-update-tmpl">
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
              <span class="AlertMessage"></span>
              <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
          </div>
        </template>

        <input type="submit" disabled hidden />
        <button id="update-btn" type="button" class="btn btn-primary">Update</button>
      </form>

    </div>

    <script>

$(function () {
    $('[data-toggle="tooltip"]').tooltip()
})

let id = getUrlParam('id');
initData();

let recoTags = [], recoLinks = [];
let oldFile = {};
let currentChecksum = '';

// 自动在标签前加井号
$('#tags-input').blur(() => {
  recoTags = getNewTags();
  $('#tags-input').val(addPrefix(recoTags, '#'));
});

function initData() {
  let form = new FormData();
  form.append('id', id);

  ajaxPost(form, '/api/reco', null, function(){
    if (this.status == 200) {
      let reco = this.response;
      oldFile = {
        size: fileSizeToString(reco.FileSize),
        name: reco.FileName,
        checksum: reco.Checksum,
      };

      if (reco.DeletedAt != "") {
        $('#section-view').hide();
        insertSuccessAlert('This file has been move to recycle bin.');
        return
      }

      if (reco.Tags) recoTags = Array.from(reco.Tags);
      if (reco.Links) recoLinks = Array.from(reco.Links);
      setReadonlyData(reco);
      setFormData(reco);
      $('#section-toggle').show();
    } else {
      insertErrorAlert(this.response.message);
    }
  });

  // Firefox 有个小 bug, 刷新页面后 switch 不会自动恢复 off 状态。
  $('#toggle-edit').prop('checked', false);
}

function setReadonlyData(reco) {
  $('#file-size').text(fileSizeToString(reco.FileSize));
  $('#file-name').text(reco.FileName);
  $('#description').text(reco.Message);
  $('#download-btn') // 后续需要增加从 COS 下载文件到缓存文件夹的功能。
    .attr('href', cacheURL(reco.ID))
    .attr('download', reco.FileName);
  recoTags.forEach(tag => insertTag(tag));
  recoLinks.forEach(link => insertLink(link));
}

function setFormData(reco) {
  if (reco.FileType.startsWith('image')) {
    $('#thumbnail')
      .css('display', 'block')
      .attr('src', thumbURL(reco.ID))
      .click(() => {
        // 如果缩略图已成功加载，点击缩略图会打开大图。
        if ($('#thumbnail')[0].naturalHeight > 0) {
          $('#thumbnail').hide();
          $('#big-image')
            .attr('src', cacheURL(reco.ID))
            .show();
          return;
        }
        // 如果缩略图加载失败，点击缩略图可向服务器申请生成缩略图。
        let form = new FormData();
        form.append('id', id);
        ajaxPost(form, '/api/thumb', null, function() {
          if (this.status == 200) {
            $('#thumbnail').attr('src', thumbUrlDate(id));
          } else {
            insertErrorAlert(this.response.message);
          }
        });
      });
  }
  $('#big-image').click(() => {
    $('#big-image').hide();
    $('#thumbnail').show();
  });
  $('#file-size-input').val(fileSizeToString(reco.FileSize));
  $('#file-name-input').val(reco.FileName);
  $('#description-input').val(reco.Message);
  $('#tags-input').val(addPrefix(recoTags, '#'));
  recoLinks.forEach(link => addLinkToForm(link));
}

function insertTag(tag) {
  let badge = $('#tag-tmpl').contents().clone();
  badge
    .text(tag)
    .attr('href', '/tag?name='+tag)
    .insertBefore('#tag-tmpl');
}

function insertLink(link) {
  let li = $('#link-tmpl').contents().clone();
  li.find('.LinkAddress').attr('href', link).text(link);
  li.insertBefore('#link-tmpl');
}

$('#toggle-edit').change(function() {
  if ($('#toggle-edit').prop('checked')) {
    $('#file-form').show();
    $('#delete-file').show();
  } else {
    $('#file-form').hide();
    $('#delete-file').hide();
    $('#delete-confirm').hide();
  }
});

$('#link-input-btn').click(event => {
  event.preventDefault();

  let link = $('#link-input').val().trim();
  if (link.length == 0) {
    return;
  }
  recoLinks.push(link);
  addLinkToForm(link);
  $('#link-input').val('').focus();
});

function addLinkToForm(link) {
  let item = $('#link-input-tmpl').contents().clone();
  item.find('.LinkAddress')
      .attr('href', link)
      .text(link);
  item.find('.DeleteButton').click(e => {
    let i = recoLinks.indexOf(link);
    recoLinks.splice(i, 1);
    e.currentTarget.parentElement.remove();
  });
  item.insertAfter('#link-input-tmpl');
}

$('#delete-file-btn').click(event => {
  event.preventDefault();
  $('#delete-file').hide();
  $('#delete-confirm').show();
});

$('#delete-no-btn').click(event => {
  $('#delete-confirm').hide();
  $('#delete-file').show();
});

$('#delete-yes-btn').click(event => {
  $('#delete-yes-btn').prop('disabled', true);
  $('#delete-no-btn').prop('disabled', true);
  $('#upload-btn').prop('disabled', true);

  let form = new FormData();
  form.append('id', id);
  let xhr = new XMLHttpRequest();
  xhr.responseType = 'json';
  xhr.open('POST', "/api/delete-reco");

  xhr.onerror = function () {
    window.alert('An error occurred during the transaction');
  };
  xhr.onload = function() {
    if (this.status == 200) {
      $('#section-view').hide();
      $('#section-toggle').hide();
      $('#file-form').hide();
      insertSuccessAlert('This file has been move to recycle bin.');
    } else {
      insertErrorAlert(this.response.message);
    }
  };
  xhr.addEventListener('loadend', function() {
    $('#delete-yes-btn').prop('disabled', false);
    $('#delete-no-btn').prop('disabled', false);
    $('#upload-btn').prop('disabled', false);
  });
  xhr.send(form);
});

$('#file-input').change(event => {
  let file = event.target.files[0];

  // Chrome 取消选择文件会使 file 变 null, Firefox 无此问题.
  if (!file) {
    $('#new-thumb').hide();
    $('#file-size-input').val(oldFile.size);
    $('#file-name-input').val(oldFile.name);
  } else {
    tryToDrawThumb(file);
    sha256Hex(file).then(hashHex => currentChecksum = hashHex);
    $('#file-size-input').val(fileSizeToString(file.size));
    $('#file-name-input').val(file.name);
  }
});

async function tryToDrawThumb(file) {
  try {
    let src = await readFilePromise(file);
    await drawThumb(src, file, '#new-thumb canvas');
    $('#new-thumb').show();
  } catch (e) {
    console.log(e);
    $('#new-thumb').hide();
  }
}

$('#update-btn').click(event => {
  event.preventDefault();
  updateFile($('#update-btn'));
});

function updateFile(btn) {
  let file = null, fileSize = oldFile.size;
  let files = document.querySelector('#file-input').files;

  // 如果选择了文件，并且所选的是新文件。
  if (files.length > 0 && currentChecksum != file.checksum) {
    file = files[0];
    fileSize = file.size;
  }

  // 如果所选的文件与旧文件一模一样。
  if (currentChecksum == file.checksum) {
    currentChecksum = '';
  }

  let form = new FormData();
  form.append('id', id);
  form.append('file', file);
  form.append('checksum', currentChecksum);
  form.append('file-name', $('#file-name-input').val()); // 在后端消除空格
  form.append('file-size', fileSize);
  form.append('description', $('#description-input').val());
  form.append('file-tags', JSON.stringify(recoTags));
  form.append('file-links', JSON.stringify(recoLinks));

  ajaxPost(form, '/api/update-file', btn, function() {
    if (this.status == 200) {
      insertSuccessAlert('OK. File Updated.');
      hideAllSections();
    } else {
      let errMsg = "Error: " + this.response.message;
      insertErrorAlert(errMsg, $('#alert-update-tmpl'));
    }
  });
}

function hideAllSections() {
  $('#section-view').hide();
  $('#section-toggle').hide();
  $('#file-form').hide();
}
    </script>
  </body>
</html>