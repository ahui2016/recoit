<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/public/bootstrap.min.css">

    <title></title>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="/public/jquery-3.5.1.min.js"></script>
    <script src="/public/bootstrap.bundle.min.js"></script>
    <script src="/public/util.js"></script>

    <style></style>

  </head>

  <body>
    <div class="container" style="max-width: 680px; min-width: 400px;">
        <nav class="navbar navbar-light bg-light mt-1">
            <span class="navbar-brand mb-0 h1"></span>
        </nav>

        <form id="file-form" style="margin-top: 50px;" autocomplete="off">
          <div class="form-group">
            <input type="file" class="form-control-file" id="file-input">
          </div>

          <!--成功提示-->
          <template id="alert-success-tmpl">
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <span class="AlertMessage"></span>
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
            </div>
          </template>

          <!--错误提示-->
          <template id="alert-danger-tmpl">
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <span class="AlertMessage"></span>
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
            </div>
          </template>

          <div id="hidden-fields" style="display: none; margin-top: 50px;">
            <div class="form-group row" id="thumbnail" style="display: none;">
              <label for="file-size" class="col-sm-2 col-form-label">Thumbnail</label>
              <div class="col-sm-10">
                <canvas class="img-thumbnail"></canvas>
              </div>
            </div>

            <div class="form-group row">
              <label for="file-size" class="col-sm-2 col-form-label">File Size</label>
              <div class="col-sm-10">
                <input type="text" readonly class="form-control-plaintext" id="file-size">
              </div>
            </div>
  
            <div class="form-group row">
              <label for="file-name" class="col-sm-2 col-form-label">File Name</label>
              <div class="col-sm-10">
                <input type="text" class="form-control" id="file-name">
              </div>
            </div>

            <div class="form-group row">
              <label for="tags-input" class="col-sm-2 col-form-label">Tags</label>
              <div class="col-sm-10">
                <input type="text" class="form-control" id="tags-input">
              </div>
            </div>

            <button id="upload-btn" type="submit" class="btn btn-primary">Upload</button>
          </div>
        </form>
    </div>

    <script>

const loadTimeLimit = 9000; // 9sec
const thumbWidth = 128, thumbHeight = 128;

let newTags = [];
let fileSha256;

$('#upload-btn').click(checkHashUpload);

$('#file-input').change(event => {
  let file = event.target.files[0];

  // Chrome 取消选择文件也会触发 change 事件, Firefox 无此问题.
  if (!file) {
    $('#hidden-fields').hide();
  } else {
    $('#hidden-fields').show();

    tryToDrawThumb(file);
    sha256Hex(file).then(hashHex => fileSha256 = hashHex);

    $('#file-size').val(fileSizeToString(file.size));
    $('#file-name').val(file.name);
  }
  $('.alert-dismissible').alert('close');
});

// 自动在标签前加井号
$('#tags-input').blur(() => {
  newTags = getNewTags();
  let tagsString = newTags.map(x => '#' + x).join(' ');
  $('#tags-input').val(tagsString);
});

async function tryToDrawThumb(file) {
  let src = await readFilePromise(file);
  try {
    await drawThumb(src, file);
    $('#thumbnail').show();
  } catch (e) {
    $('#thumbnail').hide();
  }
}

// Convert `FileReader.readAsDataURL` to promise style.
function readFilePromise(file) {
  return new Promise((resolve, reject) => {
    let reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => {
      resolve(reader.result);
    };
    reader.onerror = reject;
  });
}

// Convert `canvas.toBlob` to promise style.
// 本来想转换为 webp, 但有些浏览器不支持, 而且转换速度很慢。
function canvasToJPEG(canvas) {
  return new Promise((resolve, reject) => {
    const timeout = setTimeout(() => {
        canvas.toBlob = null;
        reject(Error('timeout'));
    }, loadTimeLimit);

    canvas.toBlob(blob => {
        clearTimeout(timeout);
        resolve(blob);
    }, 'image/jpeg', 0.92);
  });
}

function drawThumb(src, file) {
  return new Promise((resolve, reject) => {
    let img = new Image();
    img.src = src;
    img.onload = function() {

      // 截取原图中间的正方形
      let sw = img.width, sh = img.height;
      let sx = 0, sy = 0;
      if (sw > sh) {
          sx = (sw - sh) / 2;
          sw = sh;
      } else {
          sy = (sh - sw) / 2;
          sh = sw;
      }

      let thumbCanvas = $('#thumbnail canvas');
      thumbCanvas
        .attr('width', thumbWidth)
        .attr('height', thumbHeight);
      let ctx = thumbCanvas[0].getContext('2d'); // thumbCanvas[0] is the raw html-element.
      ctx.drawImage(img, sx, sy, sw, sh, 0, 0, thumbWidth, thumbHeight);

      resolve();
    };
    img.onerror = reject;
  });
}

// https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/digest
async function sha256Hex(file) {
  let buffer = await file.arrayBuffer();
  const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  return hashHex;
}

function checkHashUpload(event) {
  event.preventDefault();

  let form = new FormData();
  form.append('hashHex', fileSha256);

  let btn = $('#upload-btn');
  ajaxPost(form, '/api/checksum', btn, function() {
    if (this.status == 200) {
      uploadFile(btn);
    } else {
      let errMsg = "Error: Upload Failed. " + this.response.message;
      insertErrorAlert(errMsg);
      $('#hidden-fields').hide();
    }
  });
}

function uploadFile(btn) {
  let form = new FormData();
  let file = document.querySelector('#file-input').files[0];
  form.append('file', file);
  form.append('checksum', fileSha256);
  form.append('file-name', $('#file-name').val());
  form.append('file-size', file.size);
  form.append('file-tags', JSON.stringify(newTags));

  ajaxPost(form, '/api/upload-file', btn, function() {
    if (this.status == 200) {
      insertSuccessAlert('OK. File Uploaded.');
      $('#hidden-fields').hide();
    } else {
      console.log(`Error: ${this.status} ${JSON.stringify(this.response)}`);
    }
  });
}

function checkHashHex() {
  let form = new FormData();
  form.append('hashHex', fileSha256);
  ajaxPost(form, '/api/checksum', null, function() {
    if (this.status == 200) {
      console.log('OK');
    } else {
      console.log(`Error: ${this.status} ${JSON.stringify(this.response)}`);
    }
  });
}

    </script>
  </body>
</html>