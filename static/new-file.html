<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/public/bootstrap.min.css">

    <title></title>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="/public/jquery-3.5.1.min.js"></script>
    <script src="/public/bootstrap.bundle.min.js"></script>

    <style></style>

  </head>

  <body>
    <div class="container" style="max-width: 680px; min-width: 400px;">
        <nav class="navbar navbar-light bg-light mt-1">
            <span class="navbar-brand mb-0 h1"></span>
        </nav>

        <form id="file-form" style="margin: 50px 0 50px 0;" autocomplete="off">
          <div class="form-group" style="margin-bottom: 50px;">
            <input type="file" class="form-control-file" id="file-input">
          </div>

          <div id="hidden-fields" style="display: none;">
            <div class="form-group row" id="thumbnail" style="display: none;">
              <label for="file-size" class="col-sm-2 col-form-label">Thumbnail</label>
              <div class="col-sm-10">
                <canvas class="img-thumbnail"></canvas>
              </div>
            </div>

            <div class="form-group row">
              <label for="file-size" class="col-sm-2 col-form-label">File Size</label>
              <div class="col-sm-10">
                <input type="text" readonly class="form-control-plaintext" id="file-size">
              </div>
            </div>
  
            <div class="form-group row">
              <label for="file-name" class="col-sm-2 col-form-label">File Name</label>
              <div class="col-sm-10">
                <input type="text" class="form-control" id="file-name">
              </div>
            </div>

            <div class="form-group row">
              <label for="tags-input" class="col-sm-2 col-form-label">Tags</label>
              <div class="col-sm-10">
                <input type="text" class="form-control" id="tags-input">
              </div>
            </div>
          </div>
        </form>
    </div>

    <script>

const thumbWidth = 128, thumbHeight = 128;

let fileTags = [];
let fileSha256;

$('#file-input').change(event => {
  let file = event.target.files[0];

  // Chrome 取消选择文件也会触发 change 事件, Firefox 无此问题.
  if (!file) {
    $('#hidden-fields').hide();
  } else {
    $('#hidden-fields').show();

    tryToDrawThumb(file);
    sha256Hex(file).then(hashHex => fileSha256 = hashHex);

    $('#file-size').val(fileSizeToString(file.size));
    $('#file-name').val(file.name);
  }
});

function fileSizeToString(fileSize) {
  sizeMB = fileSize / 1024 / 1024;
  if (sizeMB < 1) {
      return `${(sizeMB * 1024).toFixed(2)} KB`;
  }
  return `${sizeMB.toFixed(2)} MB`;
}

// 自动在标签前加井号
let tagsInput = $('#tags-input');
tagsInput.blur(() => {
  let tags = getFileTags();
  let tagsString = tags.map(x => '#' + x).join(' ');
  tagsInput.val(tagsString);
});

function getFileTags() {
  let items = tagsInput.val().replace(/#/g, ' ').split(' ');
  fileTags = items.filter(x => x.length > 0);
  return fileTags;
}

async function tryToDrawThumb(file) {
  let src = await readFilePromise(file);
  try {
    await drawThumb(src, file);
    $('#thumbnail').show();
  } catch (e) {
    $('#thumbnail').hide();
  }
}

// Convert `FileReader.readAsDataURL` to promise style.
function readFilePromise(file) {
  return new Promise((resolve, reject) => {
    let reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => {
      resolve(reader.result);
    };
    reader.onerror = reject;
  });
}

function drawThumb(src, file) {
  return new Promise((resolve, reject) => {
    let img = new Image();
    img.src = src;
    img.onload = function() {

      // 截取原图中间的正方形
      let sw = img.width, sh = img.height;
      let sx = 0, sy = 0;
      if (sw > sh) {
          sx = (sw - sh) / 2;
          sw = sh;
      } else {
          sy = (sh - sw) / 2;
          sh = sw;
      }

      let thumbCanvas = $('#thumbnail canvas');
      thumbCanvas
        .attr('width', thumbWidth)
        .attr('height', thumbHeight);
      let ctx = thumbCanvas[0].getContext('2d'); // thumbCanvas[0] is the raw html-element.
      ctx.drawImage(img, sx, sy, sw, sh, 0, 0, thumbWidth, thumbHeight);

      resolve();
    };
    img.onerror = reject;
  });
}

// https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/digest
async function sha256Hex(file) {
  let buffer = await file.arrayBuffer();
  const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  return hashHex;
}

function uploadFile() {
  let form = new FormData();
  let file = document.querySelector('#file-input').files[0];
  form.append('file', file);
  form.append('checksum', fileSha256);
  form.append('file-name', $('#file-name').val());
  form.append('file-size', file.size);
  form.append('file-tags', JSON.stringify(fileTags));

  ajaxPost(form, '/api/upload-file', function() {
    if (this.status == 200) {
      console.log('OK. File Uploaded.');
    } else {
      console.log(`Error: ${this.status} ${this.statusText} ${this.responseText}`);
    }
  });
}

function checkHashHex() {
  let form = new FormData();
  form.append('hashHex', fileSha256);
  ajaxPost(form, '/api/checksum', function() {
    if (this.status == 200) {
      console.log('OK');
    } else {
      console.log(`Error: ${this.status} ${this.statusText} ${this.responseText}`);
    }
  });
}

function ajaxPost(form, url, onloadHandler) {
  let xhr = new XMLHttpRequest();
  xhr.responseType = 'json';
  xhr.open('POST', url);

  xhr.onerror = function () {
    window.alert('An error occurred during the transaction');
  }
  xhr.onload = onloadHandler;
  xhr.send(form);
}

    </script>
  </body>
</html>